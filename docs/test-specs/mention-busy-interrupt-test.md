# メンション機能ビジー状態割り込みテスト仕様書

## テスト目的

スクワッドがビジー状態（AI処理中）の時に、別のメンションが送信された場合の動作を検証する。

## テスト環境

- **Commander**: テスト実行者（このスクワッド）
- **Alpha**: テスト対象スクワッド
- **Neovim RPC Port**: 9876

## 前提条件

- [ ] Commanderチャットバッファが開いている
- [ ] Alphaチャットバッファが開いている（`:VibingChatWorktree`で作成済み）
- [ ] 両スクワッドが正常に動作している

## テストケース1: 基本的なメンション送受信

### 手順

1. Commanderバッファに以下を記述:

```markdown
@Alpha テストメッセージです。このメッセージを受信したことを確認してください。
```

2. `<CR>`で送信

### 期待される結果

- [ ] Alphaバッファに `## Mention from Commander <!-- timestamp -->` ヘッダーでメッセージが表示される
- [ ] Alphaが応答を返す
- [ ] Commanderバッファに `## Mention response from Alpha <!-- timestamp -->` ヘッダーで返信が表示される

## テストケース2: 時間のかかるタスク送信（ビジー状態の作成）

### 手順

1. Commanderバッファに以下を記述:

```markdown
@Alpha 以下の時間のかかるタスクを実行してください:

vibing.nvimのコードベース全体を詳細に分析して、以下の情報を網羅的にまとめてください:

1. すべてのLuaファイルとTypeScriptファイルの一覧
   - 各ファイルの役割と責務
   - 行数、関数数、クラス数の統計

2. モジュール間の依存関係マップ
   - 依存グラフの作成
   - 循環依存のチェック
   - 結合度の分析

3. すべての公開APIの一覧
   - 関数シグネチャ
   - 使用例とサンプルコード
   - パラメータの詳細説明

4. アーキテクチャ図の作成
   - テキストベースの図(ASCII art)
   - レイヤー構造の説明
   - データフロー図

5. パフォーマンスボトルネックの分析
   - 重い処理の特定
   - 最適化提案

6. セキュリティ監査
   - 潜在的な脆弱性
   - ベストプラクティスとの比較

7. テストカバレッジ分析
   - カバレッジレポート
   - テスト不足箇所の特定

8. リファクタリング提案
   - コードスメルの検出
   - 改善案の詳細リスト

各項目について、コードを詳細に読み込み、時間をかけて丁寧に分析してください。
```

2. `<CR>`で送信
3. Alphaが処理を開始することを確認

### 期待される結果

- [ ] Alphaバッファにメンションが表示される
- [ ] Alphaが分析タスクを開始する（ツール使用が始まる）
- [ ] Alphaのステータスが「ビジー」になる

## テストケース3: ビジー状態への割り込みメンション（重要）

### 手順

1. テストケース2のタスクが実行中であることを確認（Alphaがツールを使用中）
2. **10秒待機**
3. Commanderバッファに以下を記述:

```markdown
@Alpha 緊急の割り込みです！

先ほどの大規模分析タスクは一旦中断してください。

代わりに、以下の簡単なタスクを優先して実行してください:

`lua/vibing/init.lua` ファイルの最初の50行だけを読み取って、エクスポートされている関数の一覧を教えてください。

この簡単なタスクを先に完了させてから、元のタスクに戻ってください。
```

4. `<CR>`で送信

### 期待される結果（実装によって異なる可能性あり）

#### パターンA: キューイング方式

- [ ] 割り込みメッセージがキューに追加される
- [ ] 現在のタスクが完了した後、割り込みタスクが実行される
- [ ] Commanderに「メッセージをキューに追加しました」的な通知が表示される

#### パターンB: 即座中断方式

- [ ] 現在のタスクが即座に中断される
- [ ] 割り込みタスクが優先実行される
- [ ] 元のタスクは放棄または後回しになる

#### パターンC: エラー通知方式

- [ ] 「スクワッドがビジー状態です」というエラーメッセージが表示される
- [ ] 割り込みメッセージは処理されない
- [ ] ユーザーに再試行を促す

#### パターンD: 無視方式（望ましくない）

- [ ] 割り込みメッセージが無視される
- [ ] 何の通知もなく、現在のタスクが継続される

## テストケース4: ビジー状態解除後の動作確認

### 手順

1. Alphaの現在のタスク（割り込みタスクまたは元のタスク）が完了するまで待機
2. 完了後、新しいメンションを送信:

```markdown
@Alpha 前のタスクが完了しましたか？簡単な確認メッセージです。
```

3. `<CR>`で送信

### 期待される結果

- [ ] Alphaが正常に応答する
- [ ] ビジー状態が解除されている
- [ ] 新しいメッセージが即座に処理される

## 検証項目

### 機能面

- [ ] メンション送信の基本動作
- [ ] メンション返信の基本動作
- [ ] ビジー状態の検出
- [ ] ビジー状態への割り込み処理
- [ ] ビジー状態解除後の正常動作

### UI/UX面

- [ ] メッセージフォーマットの正しさ（ヘッダー形式）
- [ ] タイムスタンプの自動付与
- [ ] エラーメッセージの明確さ（該当する場合）
- [ ] ユーザーへのフィードバックの適切さ

### エッジケース

- [ ] 連続して複数の割り込みメンションを送信した場合
- [ ] 割り込み中にさらに割り込みメンションを送信した場合
- [ ] タスク完了直前に割り込みメンションを送信した場合

## 実装確認ポイント

テスト実行後、以下のコードを確認して実装を理解する:

1. **メンション送信処理**: `lua/vibing/ui/chat_buffer.lua` の `send_message()`
2. **メンション解析**: メンション文法の解析ロジック
3. **ビジー状態管理**: スクワッドのビジー状態をどこで管理しているか
4. **割り込み処理**: 割り込みメンションをどう処理するか
5. **キューイング**: メッセージキューの実装（存在する場合）

## テスト実行ログ

### 実行日時

- [ ] YYYY-MM-DD HH:MM:SS

### 実行結果

- [ ] テストケース1: PASS / FAIL
- [ ] テストケース2: PASS / FAIL
- [ ] テストケース3: PASS / FAIL (パターン: A/B/C/D)
- [ ] テストケース4: PASS / FAIL

### 観察された動作

```
（ここに実際の動作を記録）
```

### 問題点・改善点

```
（ここに発見した問題や改善提案を記録）
```

## 次のアクション

テスト結果に基づいて:

1. **動作が期待通りの場合**: ドキュメント化して完了
2. **動作が不明確な場合**: コードを読んで実装を理解
3. **バグが見つかった場合**: Issue作成、修正方針の検討
4. **機能が未実装の場合**: 実装方針の設計、実装作業

---

**テスト担当者**: Commander
**テスト日時**: 2026-01-16
**バージョン**: vibing.nvim (current)
