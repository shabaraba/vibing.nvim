name: Claude Code

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  issues:
    types: [opened]
  pull_request_review:
    types: [submitted]

jobs:
  claude:
    # Only allow shabaraba to trigger this workflow
    if: |
      github.actor == 'shabaraba' && (
        (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
        (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude')) ||
        (github.event_name == 'pull_request_review' && contains(github.event.review.body, '@claude')) ||
        (github.event_name == 'issues' && (contains(github.event.issue.body, '@claude') || contains(github.event.issue.title, '@claude')))
      )
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
      actions: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Claude Code
        id: claude
        # Pin to specific commit SHA for security
        uses: anthropics/claude-code-action@7145c3e0510bcdbdd29f67cc4a8c1958f1acfa2f
        env:
          GH_TOKEN: ${{ github.token }}
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

          prompt: |
            IMPORTANT: All responses MUST be in Japanese.

            REPOSITORY: ${{ github.repository }}
            EVENT_TYPE: ${{ github.event_name }}
            ISSUE_NUMBER: ${{ github.event.issue.number }}
            PR_NUMBER: ${{ github.event.pull_request.number }}

            ## FIRST STEP: Gather Context
            Before starting any work, you MUST gather complete context by running the appropriate commands:

            ### For Issue-related events (issues, issue_comment):
            ```bash
            gh issue view $ISSUE_NUMBER --comments
            ```
            This will show you the issue title, body, and ALL comments to understand the full context.

            ### For PR-related events (pull_request_review_comment, pull_request_review):
            ```bash
            gh pr view $PR_NUMBER --comments
            gh pr diff $PR_NUMBER
            ```
            This will show you the PR title, body, ALL comments, AND the code changes.

            ## Task Instructions
            After gathering the full context above:
            1. Read and understand ALL comments and discussions
            2. For PRs, review the code changes in the diff
            3. Execute the requested task based on the complete context
            4. When you complete an implementation task, create a pull request using `gh pr create` command
               - Create a descriptive PR title in English using semantic commit format
               - Write the PR body in Japanese with clear description of changes
               - Include "fixes #<issue-number>" if there's a related issue

          # Allow file operations and git/gh commands for implementation tasks
          claude_args: '--allowed-tools "Read,Edit,Write,Glob,Grep,Bash(git:*),Bash(gh:*),Bash(npm:*)"'

          # Show full output for debugging
          show_full_output: true
