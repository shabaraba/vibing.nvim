# vibing.nvim - ã‚³ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹è©³ç´°åˆ†æãƒ¬ãƒãƒ¼ãƒˆ

**ä½œæˆæ—¥**: 2025-01-16
**ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ**: vibing.nvim v1.19.0
**èª¬æ˜**: Neovim ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ - Claude AI ã‚’ Agent SDK çµŒç”±ã§çµ±åˆ

---

## ç›®æ¬¡

1. [ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ](#1-ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ)
2. [ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«é–“ã®ä¾å­˜é–¢ä¿‚](#2-ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«é–“ã®ä¾å­˜é–¢ä¿‚)
3. [å…¬é–‹API](#3-å…¬é–‹api)
4. [ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å›³](#4-ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å›³)
5. [ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹åˆ†æ](#5-ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹åˆ†æ)
6. [ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»](#6-ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»)
7. [ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸](#7-ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸)
8. [ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ææ¡ˆ](#8-ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ææ¡ˆ)

---

## 1. ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ

### 1.1 ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆçµ±è¨ˆ

| é …ç›®                                  | æ•°å€¤  |
| ------------------------------------- | ----- |
| **ç·ãƒ•ã‚¡ã‚¤ãƒ«æ•°**                      | 1,272 |
| **Luaãƒ•ã‚¡ã‚¤ãƒ«æ•°**                     | 147   |
| **TypeScriptãƒ•ã‚¡ã‚¤ãƒ«æ•°**              | 16    |
| **ãã®ä»–ï¼ˆnpmä¾å­˜ã€ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆç­‰ï¼‰** | 1,109 |

### 1.2 Luaãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆï¼ˆ147ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰

#### **lua/vibing/ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªéšå±¤**

```
lua/vibing/
â”œâ”€â”€ init.lua                          # ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆï¼ˆè¨­å®šã€ã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼åˆæœŸåŒ–ã€ã‚³ãƒãƒ³ãƒ‰ç™»éŒ²ï¼‰
â”œâ”€â”€ config.lua                        # è¨­å®šç®¡ç†ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã€ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
â”‚
â”œâ”€â”€ core/                             # åŸºæœ¬æ©Ÿèƒ½ãƒ»ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ï¼ˆ27ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰
â”‚   â”œâ”€â”€ types.lua                     # å…±é€šå‹å®šç¾©
â”‚   â”œâ”€â”€ constants/                    # å®šæ•°å®šç¾©
â”‚   â”‚   â”œâ”€â”€ init.lua
â”‚   â”‚   â”œâ”€â”€ actions.lua
â”‚   â”‚   â”œâ”€â”€ modes.lua
â”‚   â”‚   â”œâ”€â”€ tools.lua
â”‚   â”‚   â””â”€â”€ versions.lua
â”‚   â””â”€â”€ utils/                        # ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°ï¼ˆ21ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰
â”‚       â”œâ”€â”€ notify.lua                # é€šçŸ¥æ©Ÿèƒ½
â”‚       â”œâ”€â”€ ui.lua                    # UIè£œåŠ©æ©Ÿèƒ½
â”‚       â”œâ”€â”€ language.lua              # è¨€èªã‚µãƒãƒ¼ãƒˆ
â”‚       â”œâ”€â”€ timestamp.lua             # ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—å‡¦ç†
â”‚       â”œâ”€â”€ git.lua                   # Gitæ“ä½œè£œåŠ©
â”‚       â”œâ”€â”€ git_diff.lua              # Git diffå‡¦ç†
â”‚       â”œâ”€â”€ diff.lua                  # Diffå‡¦ç†
â”‚       â”œâ”€â”€ title_generator.lua       # ã‚¿ã‚¤ãƒˆãƒ«ç”Ÿæˆ
â”‚       â”œâ”€â”€ file_path.lua             # ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹å‡¦ç†
â”‚       â”œâ”€â”€ filename.lua              # ãƒ•ã‚¡ã‚¤ãƒ«åå‡¦ç†
â”‚       â”œâ”€â”€ buffer_identifier.lua     # ãƒãƒƒãƒ•ã‚¡è­˜åˆ¥
â”‚       â”œâ”€â”€ buffer_reload.lua         # ãƒãƒƒãƒ•ã‚¡å†èª­ã¿è¾¼ã¿
â”‚       â””â”€â”€ ãã®ä»–ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
â”‚
â”œâ”€â”€ domain/                           # DDD: Domainå±¤ï¼ˆãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ï¼‰
â”‚   â”œâ”€â”€ chat/
â”‚   â”‚   â”œâ”€â”€ message.lua               # ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£
â”‚   â”‚   â””â”€â”€ session.lua               # ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£
â”‚   â”œâ”€â”€ context/
â”‚   â”‚   â””â”€â”€ entity.lua                # ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£
â”‚   â”œâ”€â”€ conversation/
â”‚   â”‚   â””â”€â”€ entity.lua                # ä¼šè©±ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£
â”‚   â”œâ”€â”€ inline/
â”‚   â”‚   â””â”€â”€ entity.lua                # ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£
â”‚   â”œâ”€â”€ session/
â”‚   â”‚   â””â”€â”€ entity.lua                # ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£
â”‚   â”œâ”€â”€ permissions/
â”‚   â”‚   â”œâ”€â”€ evaluator.lua             # æ¨©é™è©•ä¾¡ã‚¨ãƒ³ã‚¸ãƒ³
â”‚   â”‚   â””â”€â”€ rule.lua                  # æ¨©é™ãƒ«ãƒ¼ãƒ«å®šç¾©
â”‚   â”œâ”€â”€ security/
â”‚   â”‚   â”œâ”€â”€ command_validator.lua     # ã‚³ãƒãƒ³ãƒ‰æ¤œè¨¼
â”‚   â”‚   â””â”€â”€ path_sanitizer.lua        # ãƒ‘ã‚¹æ­£è¦åŒ–ãƒ»ã‚µãƒ‹ã‚¿ã‚¤ã‚º
â”‚   â”œâ”€â”€ squad/                        # ãƒãƒ«ãƒã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆæ©Ÿèƒ½
â”‚   â”‚   â”œâ”€â”€ entity.lua
â”‚   â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”‚   â”œâ”€â”€ naming_service.lua
â”‚   â”‚   â”‚   â””â”€â”€ collision_resolver.lua
â”‚   â”‚   â””â”€â”€ value_objects/
â”‚   â”‚       â”œâ”€â”€ squad_name.lua
â”‚   â”‚       â””â”€â”€ squad_role.lua
â”‚   â”œâ”€â”€ mention/                      # ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³æ©Ÿèƒ½
â”‚   â”‚   â”œâ”€â”€ entity.lua
â”‚   â”‚   â”œâ”€â”€ repository.lua
â”‚   â”‚   â””â”€â”€ value_objects/
â”‚   â”‚       â”œâ”€â”€ mention_id.lua
â”‚   â”‚       â””â”€â”€ mention_status.lua
â”‚   â””â”€â”€ init.lua
â”‚
â”œâ”€â”€ application/                      # DDD: Applicationå±¤ï¼ˆãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ï¼‰
â”‚   â”œâ”€â”€ chat/                         # ãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½
â”‚   â”‚   â”œâ”€â”€ init.lua                  # ãƒãƒ£ãƒƒãƒˆåˆæœŸåŒ–
â”‚   â”‚   â”œâ”€â”€ use_case.lua              # ãƒãƒ£ãƒƒãƒˆãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹
â”‚   â”‚   â”œâ”€â”€ send_message.lua          # ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹
â”‚   â”‚   â”œâ”€â”€ commands.lua              # ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã‚³ãƒãƒ³ãƒ‰ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ custom_commands.lua       # ã‚«ã‚¹ã‚¿ãƒ ã‚³ãƒãƒ³ãƒ‰èª­ã¿è¾¼ã¿
â”‚   â”‚   â”œâ”€â”€ completion.lua            # è£œå®Œæ©Ÿèƒ½
â”‚   â”‚   â””â”€â”€ handlers/                 # ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã‚³ãƒãƒ³ãƒ‰ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ï¼ˆ14ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰
â”‚   â”‚       â”œâ”€â”€ allow.lua
â”‚   â”‚       â”œâ”€â”€ ask.lua
â”‚   â”‚       â”œâ”€â”€ clear.lua
â”‚   â”‚       â”œâ”€â”€ context.lua
â”‚   â”‚       â”œâ”€â”€ deny.lua
â”‚   â”‚       â”œâ”€â”€ help.lua
â”‚   â”‚       â”œâ”€â”€ mode.lua
â”‚   â”‚       â”œâ”€â”€ model.lua
â”‚   â”‚       â”œâ”€â”€ permission.lua
â”‚   â”‚       â”œâ”€â”€ permissions.lua
â”‚   â”‚       â”œâ”€â”€ save.lua
â”‚   â”‚       â”œâ”€â”€ set_file_title.lua
â”‚   â”‚       â”œâ”€â”€ new_session.lua
â”‚   â”‚       â””â”€â”€ summarize.lua
â”‚   â”œâ”€â”€ inline/                       # ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã‚¢ã‚¯ã‚·ãƒ§ãƒ³æ©Ÿèƒ½
â”‚   â”‚   â”œâ”€â”€ use_case.lua
â”‚   â”‚   â”œâ”€â”€ executor.lua
â”‚   â”‚   â”œâ”€â”€ queue_manager.lua
â”‚   â”‚   â””â”€â”€ modules/
â”‚   â”‚       â”œâ”€â”€ action_config.lua
â”‚   â”‚       â”œâ”€â”€ execution.lua
â”‚   â”‚       â”œâ”€â”€ prompt_builder.lua
â”‚   â”‚       â”œâ”€â”€ task_queue.lua
â”‚   â”‚       â””â”€â”€ unsaved_buffer.lua
â”‚   â”œâ”€â”€ context/
â”‚   â”‚   â””â”€â”€ manager.lua               # ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆç®¡ç†
â”‚   â”œâ”€â”€ mention/                      # ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³æ©Ÿèƒ½
â”‚   â”‚   â”œâ”€â”€ use_case.lua
â”‚   â”‚   â”œâ”€â”€ handlers/
â”‚   â”‚   â”‚   â””â”€â”€ check_mentions.lua
â”‚   â”‚   â””â”€â”€ services/
â”‚   â”‚       â”œâ”€â”€ detector.lua
â”‚   â”‚       â”œâ”€â”€ notifier.lua
â”‚   â”‚       â””â”€â”€ interruption_checker.lua
â”‚   â”œâ”€â”€ commands/
â”‚   â”‚   â””â”€â”€ handler.lua
â”‚   â””â”€â”€ init.lua
â”‚
â”œâ”€â”€ infrastructure/                   # DDD: Infrastructureå±¤ï¼ˆå®Ÿè£…è©³ç´°ï¼‰
â”‚   â”œâ”€â”€ adapter/                      # AIãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰æŠ½è±¡åŒ–
â”‚   â”‚   â”œâ”€â”€ base.lua                  # AdapteråŸºåº•ã‚¯ãƒ©ã‚¹
â”‚   â”‚   â”œâ”€â”€ agent_sdk.lua             # Agent SDKå®Ÿè£…
â”‚   â”‚   â””â”€â”€ modules/
â”‚   â”‚       â”œâ”€â”€ command_builder.lua
â”‚   â”‚       â”œâ”€â”€ event_processor.lua
â”‚   â”‚       â”œâ”€â”€ stream_handler.lua
â”‚   â”‚       â””â”€â”€ session_manager.lua
â”‚   â”œâ”€â”€ buffer/
â”‚   â”‚   â””â”€â”€ manager.lua
â”‚   â”œâ”€â”€ context/
â”‚   â”‚   â”œâ”€â”€ collector.lua
â”‚   â”‚   â””â”€â”€ formatter.lua
â”‚   â”œâ”€â”€ file/
â”‚   â”‚   â”œâ”€â”€ reader.lua
â”‚   â”‚   â””â”€â”€ writer.lua
â”‚   â”œâ”€â”€ rpc/                          # Neovim RPC ã‚µãƒ¼ãƒãƒ¼
â”‚   â”‚   â”œâ”€â”€ server.lua                # RPC ã‚µãƒ¼ãƒãƒ¼ã®ä¸»å®Ÿè£…
â”‚   â”‚   â”œâ”€â”€ registry.lua              # RPC ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ç™»éŒ²
â”‚   â”‚   â””â”€â”€ handlers/                 # RPC ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼
â”‚   â”‚       â”œâ”€â”€ buffer.lua
â”‚   â”‚       â”œâ”€â”€ cursor.lua
â”‚   â”‚       â”œâ”€â”€ execute.lua
â”‚   â”‚       â”œâ”€â”€ lsp.lua
â”‚   â”‚       â”œâ”€â”€ window.lua
â”‚   â”‚       â”œâ”€â”€ message.lua
â”‚   â”‚       â””â”€â”€ squad.lua
â”‚   â”œâ”€â”€ worktree/
â”‚   â”‚   â””â”€â”€ manager.lua               # Git worktree ç®¡ç†
â”‚   â”œâ”€â”€ ui/
â”‚   â”‚   â””â”€â”€ factory.lua
â”‚   â”œâ”€â”€ storage/                      # ãƒ•ã‚¡ã‚¤ãƒ«æ ¼ç´
â”‚   â”‚   â”œâ”€â”€ patch_parser.lua
â”‚   â”‚   â”œâ”€â”€ patch_storage.lua
â”‚   â”‚   â””â”€â”€ frontmatter.lua
â”‚   â”œâ”€â”€ nvim/
â”‚   â”‚   â””â”€â”€ command_validator.lua
â”‚   â”œâ”€â”€ squad/
â”‚   â”‚   â”œâ”€â”€ registry.lua
â”‚   â”‚   â””â”€â”€ persistence/
â”‚   â”‚       â””â”€â”€ frontmatter_repository.lua
â”‚   â”œâ”€â”€ mention/
â”‚   â”‚   â”œâ”€â”€ memory_repository.lua
â”‚   â”‚   â””â”€â”€ rpc_handlers.lua
â”‚   â””â”€â”€ init.lua
â”‚
â”œâ”€â”€ presentation/                     # DDD: Presentationå±¤ï¼ˆUIåˆ¶å¾¡ï¼‰
â”‚   â”œâ”€â”€ chat/
â”‚   â”‚   â”œâ”€â”€ controller.lua            # ãƒãƒ£ãƒƒãƒˆã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼
â”‚   â”‚   â”œâ”€â”€ view.lua                  # ãƒãƒ£ãƒƒãƒˆãƒ“ãƒ¥ãƒ¼
â”‚   â”‚   â”œâ”€â”€ buffer.lua                # ãƒãƒ£ãƒƒãƒˆãƒãƒƒãƒ•ã‚¡ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ init.lua
â”‚   â”‚   â””â”€â”€ modules/
â”‚   â”‚       â”œâ”€â”€ window_manager.lua
â”‚   â”‚       â”œâ”€â”€ file_manager.lua
â”‚   â”‚       â”œâ”€â”€ streaming_handler.lua
â”‚   â”‚       â”œâ”€â”€ header_renderer.lua
â”‚   â”‚       â”œâ”€â”€ approval_parser.lua
â”‚   â”‚       â”œâ”€â”€ programmatic_sender.lua
â”‚   â”‚       â”œâ”€â”€ collision_notifier.lua
â”‚   â”‚       â”œâ”€â”€ renderer.lua
â”‚   â”‚       â”œâ”€â”€ conversation_extractor.lua
â”‚   â”‚       â”œâ”€â”€ patch_finder.lua
â”‚   â”‚       â””â”€â”€ frontmatter_handler.lua
â”‚   â”œâ”€â”€ inline/
â”‚   â”‚   â”œâ”€â”€ controller.lua
â”‚   â”‚   â”œâ”€â”€ output_view.lua
â”‚   â”‚   â””â”€â”€ progress_view.lua
â”‚   â”œâ”€â”€ context/
â”‚   â”‚   â””â”€â”€ controller.lua
â”‚   â”œâ”€â”€ common/
â”‚   â”‚   â””â”€â”€ window.lua
â”‚   â””â”€â”€ init.lua
â”‚
â”œâ”€â”€ ui/                               # UI ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
â”‚   â”œâ”€â”€ gradient_animation.lua        # ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
â”‚   â”œâ”€â”€ permission_builder.lua        # æ¨©é™è¨­å®šUI
â”‚   â”œâ”€â”€ command_picker.lua            # ã‚³ãƒãƒ³ãƒ‰ãƒ”ãƒƒã‚«ãƒ¼UI
â”‚   â”œâ”€â”€ patch_viewer.lua              # ãƒ‘ãƒƒãƒãƒ“ãƒ¥ãƒ¼ã‚¢ãƒ¼
â”‚   â”œâ”€â”€ inline_picker.lua             # ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ãƒ”ãƒƒã‚«ãƒ¼
â”‚   â”œâ”€â”€ inline_preview.lua
â”‚   â”œâ”€â”€ output_buffer.lua
â”‚   â””â”€â”€ inline_preview/
â”‚       â”œâ”€â”€ layout.lua
â”‚       â”œâ”€â”€ renderer.lua
â”‚       â”œâ”€â”€ state.lua
â”‚       â”œâ”€â”€ handlers.lua
â”‚       â””â”€â”€ keymaps.lua
â”‚
â”œâ”€â”€ integrations/
â”‚   â””â”€â”€ oil.lua                       # oil.nvim çµ±åˆ
â”‚
â”œâ”€â”€ mcp/
â”‚   â””â”€â”€ setup.lua                     # MCP ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
â”‚
â””â”€â”€ install.lua                       # ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
```

### 1.3 TypeScriptãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆï¼ˆ16ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰

```
bin/
â”œâ”€â”€ agent-wrapper.ts                  # Agent SDK ãƒ©ãƒƒãƒ‘ãƒ¼ï¼ˆãƒ¡ã‚¤ãƒ³å®Ÿè£…ï¼‰
â”œâ”€â”€ types.ts                          # å‹å®šç¾©
â”œâ”€â”€ register-mcp.ts                   # MCP ã‚µãƒ¼ãƒãƒ¼ç™»éŒ²
â”œâ”€â”€ lib/
â”‚   â”œâ”€â”€ args-parser.ts                # ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³å¼•æ•°ãƒ‘ãƒ¼ã‚µãƒ¼
â”‚   â”œâ”€â”€ prompt-builder.ts             # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæ§‹ç¯‰
â”‚   â”œâ”€â”€ stream-processor.ts           # ã‚¹ãƒˆãƒªãƒ¼ãƒ å‡¦ç†ã‚¨ãƒ³ã‚¸ãƒ³
â”‚   â”œâ”€â”€ patch-storage.ts              # ãƒ‘ãƒƒãƒãƒ•ã‚¡ã‚¤ãƒ«æ ¼ç´
â”‚   â”œâ”€â”€ git-operations.ts             # Git æ“ä½œ
â”‚   â”œâ”€â”€ utils.ts                      # ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
â”‚   â”œâ”€â”€ rpc/
â”‚   â”‚   â”œâ”€â”€ client.ts                 # RPC ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
â”‚   â”‚   â””â”€â”€ types.ts                  # RPC å‹å®šç¾©
â”‚   â”œâ”€â”€ permissions/
â”‚   â”‚   â”œâ”€â”€ can-use-tool.ts           # ãƒ„ãƒ¼ãƒ«ä½¿ç”¨æ¨©é™åˆ¤å®š
â”‚   â”‚   â”œâ”€â”€ rule-checker.ts           # ãƒ«ãƒ¼ãƒ«è©•ä¾¡
â”‚   â”‚   â””â”€â”€ matchers.ts               # ãƒãƒƒãƒãƒ£ãƒ¼å®Ÿè£…
â”‚   â””â”€â”€ mention/
â”‚       â”œâ”€â”€ types.ts                  # ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³å‹å®šç¾©
â”‚       â””â”€â”€ checker.ts                # ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³æ¤œå‡º

mcp-server/
â”œâ”€â”€ (Express ãƒ™ãƒ¼ã‚¹ã® MCP ã‚µãƒ¼ãƒãƒ¼å®Ÿè£…)
```

---

## 2. ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«é–“ã®ä¾å­˜é–¢ä¿‚

### 2.1 é«˜ãƒ¬ãƒ™ãƒ«ä¾å­˜é–¢ä¿‚ãƒãƒƒãƒ—

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  init.lua (ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ)                               â”‚
â”‚  â”œâ”€ config.lua (è¨­å®šç®¡ç†)                                   â”‚
â”‚  â”œâ”€ infrastructure/adapter/agent_sdk.lua                    â”‚
â”‚  â”‚  â””â”€ infrastructure/adapter/base.lua                      â”‚
â”‚  â”œâ”€ presentation/chat/controller.lua                        â”‚
â”‚  â”‚  â”œâ”€ application/chat/use_case.lua                        â”‚
â”‚  â”‚  â”œâ”€ presentation/chat/view.lua                           â”‚
â”‚  â”‚  â””â”€ infrastructure/worktree/manager.lua                  â”‚
â”‚  â”œâ”€ presentation/inline/controller.lua                      â”‚
â”‚  â”‚  â””â”€ application/inline/use_case.lua                      â”‚
â”‚  â””â”€ presentation/context/controller.lua                     â”‚
â”‚     â””â”€ application/context/manager.lua                      â”‚
â”‚
â”œâ”€ application/ (ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹å±¤)
â”‚  â”œâ”€ chat/use_case.lua
â”‚  â”‚  â”œâ”€ domain/permissions/evaluator.lua
â”‚  â”‚  â”œâ”€ infrastructure/context/collector.lua
â”‚  â”‚  â”œâ”€ infrastructure/file/reader.lua
â”‚  â”‚  â””â”€ infrastructure/adapter/
â”‚  â”‚
â”‚  â””â”€ inline/use_case.lua
â”‚     â””â”€ application/inline/queue_manager.lua
â”‚
â”œâ”€ infrastructure/ (å®Ÿè£…å±¤)
â”‚  â”œâ”€ adapter/ (AIãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰æŠ½è±¡åŒ–)
â”‚  â”‚  â”œâ”€ agent_sdk.lua
â”‚  â”‚  â”‚  â””â”€ bin/agent-wrapper.ts
â”‚  â”‚  â””â”€ modules/
â”‚  â”‚     â””â”€ command_builder.lua
â”‚  â”‚        â”œâ”€ lib/prompt-builder.ts
â”‚  â”‚        â””â”€ lib/args-parser.ts
â”‚  â”‚
â”‚  â””â”€ rpc/server.lua (Neovim RPC ã‚µãƒ¼ãƒãƒ¼)
â”‚     â””â”€ bin/mcp-server/
â”‚
â””â”€ presentation/ (UIå±¤)
   â””â”€ å„ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ â†’ ãƒ“ãƒ¥ãƒ¼
```

### 2.2 å±¤åˆ¥ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

#### **Presentationå±¤ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼I/Oï¼‰**

- `presentation/chat/controller.lua` - ãƒãƒ£ãƒƒãƒˆæ“ä½œ
- `presentation/chat/view.lua` - UI ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
- `presentation/inline/controller.lua` - ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³æ“ä½œ
- `ui/*` - UI ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

#### **Applicationå±¤ï¼ˆãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ï¼‰**

- `application/chat/use_case.lua` - ãƒãƒ£ãƒƒãƒˆãƒ­ã‚¸ãƒƒã‚¯
- `application/inline/use_case.lua` - ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ãƒ­ã‚¸ãƒƒã‚¯
- `application/*/handlers/*` - ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã‚³ãƒãƒ³ãƒ‰ãƒãƒ³ãƒ‰ãƒ©ãƒ¼

#### **Domainå±¤ï¼ˆãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ï¼‰**

- `domain/permissions/evaluator.lua` - æ¨©é™åˆ¤å®š
- `domain/security/*` - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ­ã‚¸ãƒƒã‚¯
- `domain/squad/*` - ãƒãƒ«ãƒã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆç®¡ç†

#### **Infrastructureå±¤ï¼ˆå®Ÿè£…è©³ç´°ï¼‰**

- `infrastructure/adapter/agent_sdk.lua` - Agent SDK å®Ÿè£…
- `infrastructure/rpc/server.lua` - Neovim RPC ã‚µãƒ¼ãƒãƒ¼
- `infrastructure/file/*` - ãƒ•ã‚¡ã‚¤ãƒ«I/O
- `bin/agent-wrapper.ts` - Node.js ãƒ©ãƒƒãƒ‘ãƒ¼
- `bin/mcp-server/` - MCP ã‚µãƒ¼ãƒãƒ¼å®Ÿè£…

### 2.3 ä¸»è¦ãƒ•ã‚¡ã‚¤ãƒ«é–“ã®ä¾å­˜é–¢ä¿‚ï¼ˆè©³ç´°ï¼‰

| ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«                 | ä¾å­˜å…ƒ        | ä¾å­˜å…ˆ               | èª¬æ˜               |
| -------------------------- | ------------- | -------------------- | ------------------ |
| `init.lua`                 | -             | adapter, controllers | ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ |
| `adapter/agent_sdk.lua`    | controller    | bin/agent-wrapper.ts | AIé€šä¿¡             |
| `agent-wrapper.ts`         | adapter       | lib/\*               | Agent SDK ãƒ©ãƒƒãƒ‘ãƒ¼ |
| `prompt-builder.ts`        | agent-wrapper | args-parser          | ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæ§‹ç¯‰     |
| `stream-processor.ts`      | agent-wrapper | event-processor      | ã‚¹ãƒˆãƒªãƒ¼ãƒ å‡¦ç†     |
| `rpc/server.lua`           | init          | infrastructure/\*    | RPC ã‚µãƒ¼ãƒãƒ¼       |
| `permission/evaluator.lua` | use_case      | rule, security/\*    | æ¨©é™åˆ¤å®š           |

---

## 3. å…¬é–‹API

### 3.1 ãƒ—ãƒ©ã‚°ã‚¤ãƒ³è¨­å®šAPI

```lua
require("vibing").setup({
  agent = {
    default_mode = "code",        -- "code"|"plan"|"explore"
    default_model = "sonnet",     -- "sonnet"|"opus"|"haiku"
    prioritize_vibing_lsp = true,
  },
  chat = {
    window = {
      position = "current",       -- "current"|"right"|"left"|"top"|"bottom"|"back"|"float"
      width = 0.4,
      height = 0.4,
      border = "rounded",
    },
    auto_context = true,
    save_location_type = "project",
    context_position = "append",
  },
  ui = {
    wrap = "on",
    gradient = {
      enabled = true,
      colors = { "#cc3300", "#fffe00" },
      interval = 100,
    },
    tool_result_display = "compact", -- "none"|"compact"|"full"
  },
  keymaps = {
    send = "<CR>",
    cancel = "<C-c>",
    add_context = "<C-a>",
    open_diff = "gd",
    open_file = "gf",
  },
  permissions = {
    mode = "acceptEdits",         -- "default"|"acceptEdits"|"bypassPermissions"
    allow = { "Read", "Edit", "Write", "Glob", "Grep" },
    deny = { "Bash" },
    rules = {},                   -- Granular permission rules
  },
  mcp = {
    enabled = true,
    rpc_port = 9876,
  },
  language = nil,                 -- "ja"|"en"|LanguageConfig
})
```

### 3.2 ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚³ãƒãƒ³ãƒ‰

#### **ãƒãƒ£ãƒƒãƒˆé–¢é€£**

```vim
:VibingChat [position|file]       # æ–°è¦ãƒãƒ£ãƒƒãƒˆã¾ãŸã¯ãƒ•ã‚¡ã‚¤ãƒ«é–‹ã
:VibingChatWorktree [pos] <branch> # Worktreeã§ãƒãƒ£ãƒƒãƒˆé–‹ã
:VibingToggleChat                 # ãƒãƒ£ãƒƒãƒˆã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãƒˆã‚°ãƒ«
```

#### **ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆé–¢é€£**

```vim
:VibingContext [file]             # ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã«è¿½åŠ 
:VibingClearContext               # ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚¯ãƒªã‚¢
```

#### **ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã‚¢ã‚¯ã‚·ãƒ§ãƒ³**

```vim
:VibingInline [action|prompt]     # ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
:'<,'>VibingInline fix            # ã‚³ãƒ¼ãƒ‰ä¿®æ­£
:'<,'>VibingInline explain        # ã‚³ãƒ¼ãƒ‰èª¬æ˜
```

#### **ãã®ä»–**

```vim
:VibingCancel                     # ç¾åœ¨ã®å®Ÿè¡Œã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
:VibingSlashCommands              # ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã‚³ãƒãƒ³ãƒ‰è¡¨ç¤º
:VibingSetFileTitle               # AIã‚¿ã‚¤ãƒˆãƒ«ç”Ÿæˆ
:VibingReloadCommands             # ã‚«ã‚¹ã‚¿ãƒ ã‚³ãƒãƒ³ãƒ‰å†èª­ã¿è¾¼ã¿
```

### 3.3 ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã‚³ãƒãƒ³ãƒ‰ï¼ˆãƒãƒ£ãƒƒãƒˆå†…ï¼‰

```markdown
/mode <mode> # å®Ÿè¡Œãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ
/model <model> # ãƒ¢ãƒ‡ãƒ«åˆ‡ã‚Šæ›¿ãˆ
/context <file> # ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆè¿½åŠ 
/clear # ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚¯ãƒªã‚¢
/save # ãƒãƒ£ãƒƒãƒˆä¿å­˜
/permissions or /perm # æ¨©é™è¨­å®šUI
/allow [tool] # ãƒ„ãƒ¼ãƒ«è¨±å¯ãƒªã‚¹ãƒˆç®¡ç†
/deny [tool] # ãƒ„ãƒ¼ãƒ«æ‹’å¦ãƒªã‚¹ãƒˆç®¡ç†
/help # ãƒ˜ãƒ«ãƒ—è¡¨ç¤º
/summarize # ä¼šè©±è¦ç´„
```

### 3.4 ãƒ—ãƒ­ã‚°ãƒ©ãƒãƒ†ã‚£ãƒƒã‚¯API

#### **Adapterã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹**

```lua
local adapter = require("vibing").get_adapter()

-- ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°å®Ÿè¡Œ
local handle_id = adapter:stream(
  prompt,
  { context = {...}, mode = "code", model = "sonnet" },
  function(chunk) print(chunk) end,  -- on_chunk
  function(response) print(response.content) end  -- on_done
)

-- ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°å®Ÿè¡Œã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
adapter:cancel(handle_id)

-- åŒæœŸå®Ÿè¡Œï¼ˆãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚°ï¼‰
local response = adapter:execute(prompt, { context = {...} })
```

#### **æ¨©é™è©•ä¾¡API**

```lua
local evaluator = require("vibing.domain.permissions.evaluator")
local allowed = evaluator.can_use_tool(
  "Bash",
  { command = "npm install" },
  permission_config
)
```

---

## 4. ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å›³

### 4.1 ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Neovim Instance                               â”‚
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Presentation Layer (UI/Input)                                  â”‚ â”‚
â”‚  â”‚                                                                â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚ â”‚
â”‚  â”‚  â”‚ ChatView     â”‚  â”‚ InlineView   â”‚  â”‚ ContextView  â”‚        â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚ â”‚
â”‚  â”‚         â”‚                  â”‚                 â”‚                 â”‚ â”‚
â”‚  â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚ â”‚
â”‚  â”‚                            â”‚                                   â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚  â”‚ Controllers (chat, inline, context)                      â”‚ â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                               â”‚                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Application Layer (Use Cases)                                  â”‚ â”‚
â”‚  â”‚                                                                â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚ â”‚
â”‚  â”‚  â”‚ ChatUseCase    â”‚  â”‚ InlineUseCaseâ”‚  â”‚ ContextManager  â”‚   â”‚ â”‚
â”‚  â”‚  â”‚ (messaging,    â”‚  â”‚ (execution,  â”‚  â”‚ (collection,    â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  storage,      â”‚  â”‚  queueing)   â”‚  â”‚  formatting)    â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  handlers)     â”‚  â”‚              â”‚  â”‚                 â”‚   â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ â”‚
â”‚  â”‚           â”‚                   â”‚                 â”‚             â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚ â”‚
â”‚  â”‚  â”‚ Slash Command Handlers (/mode, /model, /save, etc.)  â”‚   â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ â”‚
â”‚  â”‚                              â”‚                                 â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                 â”‚                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Domain Layer (Business Logic)                                 â”‚ â”‚
â”‚  â”‚                                                               â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚ â”‚
â”‚  â”‚  â”‚ Permission Evaluator                                 â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  â”œâ”€ Rule Evaluation                                  â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  â”œâ”€ Path Sanitization                               â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  â””â”€ Command Validation                              â”‚   â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ â”‚
â”‚  â”‚                 â”‚                                            â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚ â”‚
â”‚  â”‚  â”‚ Entity Models (Message, Session, Context, etc.)     â”‚   â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ â”‚
â”‚  â”‚                                                               â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚ â”‚
â”‚  â”‚  â”‚ Squad Management (Multi-Agent System)               â”‚   â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Infrastructure Layer (Implementation)                         â”‚ â”‚
â”‚  â”‚                                                               â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚ â”‚
â”‚  â”‚  â”‚ Adapter Pattern (AI Backend Abstraction)           â”‚    â”‚ â”‚
â”‚  â”‚  â”‚  â”œâ”€ Agent SDK Adapter âœ“ (recommended)             â”‚    â”‚ â”‚
â”‚  â”‚  â”‚  â”œâ”€ Claude Adapter (alternative)                  â”‚    â”‚ â”‚
â”‚  â”‚  â”‚  â””â”€ Claude ACP Adapter (alternative)              â”‚    â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚ â”‚
â”‚  â”‚                 â”‚                                           â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚ â”‚
â”‚  â”‚  â”‚ Agent Wrapper (TypeScript, bin/agent-wrapper.ts)        â”‚ â”‚
â”‚  â”‚  â”‚                                                â”‚       â”‚ â”‚
â”‚  â”‚  â”‚  â”œâ”€ Prompt Builder                            â”‚       â”‚ â”‚
â”‚  â”‚  â”‚  â”œâ”€ Stream Processor                          â”‚       â”‚ â”‚
â”‚  â”‚  â”‚  â”œâ”€ Permission Check                          â”‚       â”‚ â”‚
â”‚  â”‚  â”‚  â”œâ”€ Context Formatting                        â”‚       â”‚ â”‚
â”‚  â”‚  â”‚  â””â”€ Session Management                        â”‚       â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚ â”‚
â”‚  â”‚                 â”‚                                           â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚ â”‚
â”‚  â”‚  â”‚ File I/O, Buffer Management, RPC Server        â”‚       â”‚ â”‚
â”‚  â”‚  â”‚ Git Operations, Worktree Management            â”‚       â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚ â”‚
â”‚  â”‚                                                               â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚ â”‚
â”‚  â”‚  â”‚ RPC Server (Neovim â†â†’ Node.js Communication)       â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  â”œâ”€ Buffer Operations Handler                       â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  â”œâ”€ Cursor Operations Handler                       â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  â”œâ”€ LSP Handler                                     â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  â”œâ”€ Window Management Handler                       â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  â””â”€ Squad Operations Handler                        â”‚   â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                      â”‚                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚                                             â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
         â”‚  Node.js Process â”‚                         â”‚ MCP Server  â”‚
         â”‚  (Agent Wrapper) â”‚                         â”‚  (Optional) â”‚
         â”‚                  â”‚                         â”‚             â”‚
         â”‚ â”œâ”€ Agent SDK     â”‚                         â”‚ â”œâ”€ Buffer   â”‚
         â”‚ â”œâ”€ Permissions   â”‚                         â”‚ â”œâ”€ LSP      â”‚
         â”‚ â”œâ”€ Stream Proc.  â”‚                         â”‚ â”œâ”€ Windows  â”‚
         â”‚ â””â”€ Git Ops       â”‚                         â”‚ â””â”€ Squad    â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                       â”‚                    â”‚
                             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”
                             â”‚ Claude Agent SDK â”‚   â”‚  Local Git  â”‚
                             â”‚  API Integration â”‚   â”‚  Operations â”‚
                             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼å›³ï¼ˆãƒãƒ£ãƒƒãƒˆå®Ÿè¡Œï¼‰

```
User Input (Message)
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ChatView.on_send()  â”‚
â”‚ (Frontmatter Parse) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ChatUseCase.send_message()   â”‚
â”‚ â”œâ”€ Permission Check          â”‚
â”‚ â”œâ”€ Context Collection        â”‚
â”‚ â”œâ”€ Session Retrieval         â”‚
â”‚ â””â”€ Adapter.stream() Call     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ AgentSDKAdapter.stream()     â”‚
â”‚ â”œâ”€ Command Builder           â”‚
â”‚ â”œâ”€ vim.system() Launch       â”‚
â”‚ â””â”€ Output Handler Setup      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Node.js Process              â”‚
â”‚ (agent-wrapper.ts)           â”‚
â”‚ â”œâ”€ Prompt Builder            â”‚
â”‚ â”œâ”€ Permission Check          â”‚
â”‚ â”œâ”€ Agent SDK Query           â”‚
â”‚ â””â”€ JSON Lines Output         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Streaming Response           â”‚
â”‚ (JSON Lines Protocol)        â”‚
â”‚ â”œâ”€ Chunk Events              â”‚
â”‚ â”œâ”€ Tool Use Events           â”‚
â”‚ â””â”€ Done Event                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ StreamHandler                â”‚
â”‚ â”œâ”€ Event Processing          â”‚
â”‚ â”œâ”€ Text Accumulation         â”‚
â”‚ â”œâ”€ Tool Use Parsing          â”‚
â”‚ â””â”€ Session ID Storage        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ on_chunk() / on_done()       â”‚
â”‚ Callbacks                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ChatView.render()            â”‚
â”‚ â”œâ”€ Buffer Update             â”‚
â”‚ â”œâ”€ Highlighting              â”‚
â”‚ â””â”€ Markdown Rendering        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
User sees response in chat
```

### 4.3 æ¨©é™ãƒã‚§ãƒƒã‚¯ãƒ•ãƒ­ãƒ¼

```
Tool Use Request
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ can-use-tool.ts callback     â”‚
â”‚ (Node.js)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. Denied Tools Check                â”‚
â”‚    - Explicit deny list              â”‚
â”‚    - Tool in deny list? â†’ DENY       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. Permission Mode Check             â”‚
â”‚    - bypassPermissions â†’ ALLOW       â”‚
â”‚    - acceptEdits mode                â”‚
â”‚    - default mode                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. Granular Rule Evaluation          â”‚
â”‚    - Path sanitization               â”‚
â”‚    - Command pattern matching        â”‚
â”‚    - Domain validation               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. Allow List Check                  â”‚
â”‚    - Tool in allow list? â†’ ALLOW     â”‚
â”‚    - Otherwise â†’ DENY/ASK            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
Result: ALLOW / DENY / ASK_USER
```

---

## 5. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹åˆ†æ

### 5.1 æ½œåœ¨çš„ãªãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒœãƒˆãƒ«ãƒãƒƒã‚¯

#### **1. ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°å‡¦ç†ï¼ˆé«˜å„ªå…ˆåº¦ï¼‰**

| é …ç›®                 | å•é¡Œ                            | å½±éŸ¿        | æ¨å¥¨æ”¹å–„                    |
| -------------------- | ------------------------------- | ----------- | --------------------------- |
| **JSON Line ãƒ‘ãƒ¼ã‚¹** | å„ãƒãƒ£ãƒ³ã‚¯ã§ JSON.parse         | UI åå¿œé…å»¶ | ãƒãƒƒãƒ•ã‚¡ãƒªãƒ³ã‚° + ãƒãƒƒãƒå‡¦ç† |
| **ãƒãƒƒãƒ•ã‚¡æ›´æ–°é »åº¦** | ãƒãƒ£ãƒ³ã‚¯æ¯ã« nvim_buf_set_lines | é‡ã„        | è¤‡æ•°ãƒãƒ£ãƒ³ã‚¯ = 1 å›ã®æ›´æ–°   |
| **Diff è¨ˆç®—**        | æ¯å›å…¨æ–‡ diff                   | CPU æ¶ˆè²»    | Incremental diff ã®ã¿       |

#### **2. ãƒ•ã‚¡ã‚¤ãƒ«I/Oï¼ˆä¸­å„ªå…ˆåº¦ï¼‰**

| é …ç›®                 | å•é¡Œ                 | å½±éŸ¿       | æ¨å¥¨æ”¹å–„             |
| -------------------- | -------------------- | ---------- | -------------------- |
| **Context èª­ã¿è¾¼ã¿** | ãƒ•ã‚¡ã‚¤ãƒ«æ¯ã«èª­ã¿è¾¼ã¿ | ãƒ¡ãƒ¢ãƒªæ¶ˆè²» | Lazy loading         |
| **Chat ä¿å­˜**        | åŒæœŸçš„ã«æ›¸ãè¾¼ã¿     | UI ãƒãƒ³ã‚°  | éåŒæœŸ write         |
| **Session ãƒ•ã‚¡ã‚¤ãƒ«** | æ¯å› JSONL ãƒ‘ãƒ¼ã‚¹    | é€Ÿåº¦ä½ä¸‹   | ã‚¤ãƒ³ãƒ¡ãƒ¢ãƒªã‚­ãƒ£ãƒƒã‚·ãƒ¥ |

#### **3. RPC ã‚µãƒ¼ãƒãƒ¼ï¼ˆä½å„ªå…ˆåº¦ï¼‰**

| é …ç›®             | å•é¡Œ               | å½±éŸ¿     | æ¨å¥¨æ”¹å–„   |
| ---------------- | ------------------ | -------- | ---------- |
| **LSP å‘¼ã³å‡ºã—** | åŒæœŸçš„ãƒªã‚¯ã‚¨ã‚¹ãƒˆ   | å¾…æ©Ÿæ™‚é–“ | ãƒãƒƒãƒåŒ–   |
| **ãƒãƒƒãƒ•ã‚¡æ“ä½œ** | è¤‡æ•°æ“ä½œã®å€‹åˆ¥å®Ÿè¡Œ | å¾€å¾©å¢—åŠ  | ãƒãƒƒãƒ API |

### 5.2 ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒªãƒ³ã‚°çµæœ

#### **ãƒœãƒˆãƒ«ãƒãƒƒã‚¯ç®‡æ‰€ï¼ˆæ¨å®šï¼‰**

1. **stream-processor.ts** (agent-wrapper å†…)
   - ```typescript
     for (const line of lines) {
       const json = JSON.parse(line); // æ¯è¡Œãƒ‘ãƒ¼ã‚¹ â†’ ãƒãƒƒãƒå‡¦ç†æ¨å¥¨
       // ...
     }
     ```
   - æ”¹å–„: JSON ãƒ‘ãƒ¼ã‚¹å‰ã«ãƒãƒ£ãƒ³ã‚¯ã‚’ãƒãƒƒãƒ•ã‚¡ãƒªãƒ³ã‚°

2. **presentation/chat/view.lua**
   - ```lua
     vim.api.nvim_buf_set_lines(buf, start, end, false, lines)  -- é«˜é »åº¦å‘¼ã³å‡ºã—
     ```
   - æ”¹å–„: ãƒãƒ£ãƒ³ã‚¯å˜ä½ã§å‘¼ã³å‡ºã— â†’ è¤‡æ•°è¡Œä¸€æ‹¬å‡¦ç†

3. **presentation/chat/modules/renderer.lua**
   - Markdown ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°æ¯å›å…¨è¡Œå‡¦ç†
   - æ”¹å–„: Incremental rendering

4. **infrastructure/adapter/modules/stream_handler.lua**
   - Event å‡¦ç†æ¯ã«è¤‡æ•°ã® Lua ã‚µã‚¤ãƒ‰ã‚³ãƒ¼ãƒ«
   - æ”¹å–„: ãƒãƒƒãƒå‡¦ç†åŒ–

### 5.3 æœ€é©åŒ–ã®æ¨å¥¨é †ä½

| å„ªå…ˆåº¦        | æ”¹å–„å†…å®¹              | æ¨å®šåŠ¹æœ    | å®Ÿè£…è¤‡é›‘åº¦ |
| ------------- | --------------------- | ----------- | ---------- |
| **ğŸ”´ High**   | Stream ãƒãƒƒãƒå‡¦ç†     | UIåå¿œ +30% | ä¸­         |
| **ğŸ”´ High**   | Buffer æ›´æ–°ã®ãƒãƒƒãƒåŒ– | UIåå¿œ +25% | ä½         |
| **ğŸŸ¡ Medium** | Context lazy loading  | ãƒ¡ãƒ¢ãƒª -40% | é«˜         |
| **ğŸŸ¡ Medium** | Chat ä¿å­˜ã®éåŒæœŸåŒ–   | ãƒãƒ³ã‚°è§£æ¶ˆ  | ä¸­         |
| **ğŸŸ¢ Low**    | RPC ãƒãƒƒãƒåŒ–          | å¾€å¾© -50%   | é«˜         |

---

## 6. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»

### 6.1 ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒªã‚¹ã‚¯è©•ä¾¡

#### **ğŸ”´ Critical Issues**

1. **Path Traversal è„†å¼±æ€§ - ä¸­ç¨‹åº¦ãƒªã‚¹ã‚¯**
   - **ç®‡æ‰€**: `infrastructure/file/reader.lua`, `infrastructure/file/writer.lua`
   - **å•é¡Œ**: ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ãƒ‘ã‚¹ã®ä¸ååˆ†ãªã‚µãƒ‹ã‚¿ã‚¤ã‚º
   - **å½±éŸ¿**: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå¤–ãƒ•ã‚¡ã‚¤ãƒ«ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹
   - **ç¾çŠ¶**: `domain/security/path_sanitizer.lua` ã§å¯¾ç­–å®Ÿè£…æ¸ˆã¿
   - **è©•ä¾¡**: âœ“ å¯¾ç­–å®Ÿè£…æ¸ˆã¿

2. **Command Injection - ä½ãƒªã‚¹ã‚¯**
   - **ç®‡æ‰€**: `bin/lib/git-operations.ts`
   - **å•é¡Œ**: Git ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œæ™‚ã®å…¥åŠ›æ¤œè¨¼
   - **ç¾çŠ¶**:
     ```typescript
     // Branch name ãŒæ­£è¦è¡¨ç¾ã§æ¤œè¨¼ã•ã‚Œã¦ã„ã‚‹
     if (!branchName.match(/^[a-zA-Z0-9._-]+$/)) {
       throw new Error('Invalid branch name');
     }
     ```
   - **è©•ä¾¡**: âœ“ åŸºæœ¬çš„ãªæ¤œè¨¼ã‚ã‚Šï¼ˆå¼·åŒ–æ¨å¥¨ï¼‰

3. **ç’°å¢ƒå¤‰æ•° Leak - ä½ãƒªã‚¹ã‚¯**
   - **ç®‡æ‰€**: `infrastructure/adapter/agent_sdk.lua`
   - **å•é¡Œ**: `vim.fn.environ()` ã§å…¨ç’°å¢ƒå¤‰æ•°ã‚’ Agent SDK ã«æ¸¡ã™
   - **å½±éŸ¿**: API ã‚­ãƒ¼ãªã©ã®æ¼æ´©
   - **ç¾çŠ¶**:
     ```lua
     env = vim.fn.environ(),  -- å…¨ç’°å¢ƒå¤‰æ•°ã‚’ã‚³ãƒ”ãƒ¼
     ```
   - **æ¨å¥¨**: ãƒ›ãƒ¯ã‚¤ãƒˆãƒªã‚¹ãƒˆæ–¹å¼ã«å¤‰æ›´

#### **ğŸŸ¡ Medium Issues**

1. **æ¨©é™è¨­å®šã®è¤‡é›‘æ€§**
   - **å•é¡Œ**: Granular rules ã®ç›¸äº’ä½œç”¨ãŒè¤‡é›‘
   - **å½±éŸ¿**: ãƒ«ãƒ¼ãƒ«è©•ä¾¡ã®äºˆæ¸¬å›°é›£æ€§
   - **æ¨å¥¨**: ãƒ«ãƒ¼ãƒ«å„ªå…ˆåº¦ã®æ˜ç¢ºåŒ–ã€ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹è¿½åŠ 

2. **Session ID ã®æš—å·å­¦çš„å¼·åº¦**
   - **ç®‡æ‰€**: `infrastructure/adapter/modules/session_manager.lua`
   - **å•é¡Œ**: `math.random()` ãƒ™ãƒ¼ã‚¹ã® ID ç”Ÿæˆ
   - **æ¨å¥¨**: `os.urandom()` ã¾ãŸã¯ crypto ãƒ©ã‚¤ãƒ–ãƒ©ãƒªä½¿ç”¨

3. **RPC ã‚µãƒ¼ãƒãƒ¼ã®èªè¨¼ãªã—**
   - **ç®‡æ‰€**: `infrastructure/rpc/server.lua`
   - **å•é¡Œ**: localhost ã®ã¿ã ãŒèªè¨¼ãƒ¡ã‚«ãƒ‹ã‚ºãƒ ãªã—
   - **æ¨å¥¨**: Token ãƒ™ãƒ¼ã‚¹ã®èªè¨¼è¿½åŠ 

#### **ğŸŸ¢ Low Issues**

1. **ãƒ­ã‚°å†…å®¹ã®æ©Ÿå¯†æ€§**
   - **å•é¡Œ**: ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«æ©Ÿå¯†æƒ…å ±ãŒå«ã¾ã‚Œã‚‹å¯èƒ½æ€§
   - **æ¨å¥¨**: ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«åˆ¥ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°

2. **ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³**
   - **å•é¡Œ**: Chat ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³è¨­å®šãŒãªã„
   - **æ¨å¥¨**: ãƒ¢ãƒ¼ãƒ‰ 0600 ã§ä½œæˆ

### 6.2 æ¨©é™ãƒã‚§ãƒƒã‚¯å®Ÿè£…ã®å®‰å…¨æ€§

#### **ç¾åœ¨ã®å®Ÿè£…**

- âœ“ Deny-first ã‚¢ãƒ—ãƒ­ãƒ¼ãƒï¼ˆdeny ãŒ allow ã‚’ä¸Šæ›¸ãï¼‰
- âœ“ Granular rules (path, command pattern, domain)
- âœ“ è¤‡æ•°æ¨©é™ãƒ¢ãƒ¼ãƒ‰ (default, acceptEdits, bypassPermissions)
- âœ“ Path sanitization (symlink è§£æ±ºã€æ­£è¦åŒ–)

#### **æ”¹å–„ææ¡ˆ**

```lua
-- ç¾åœ¨
if denied_tools[tool] then
  return false  -- OK
end

-- æ”¹å–„: ãƒ«ãƒ¼ãƒ«å„ªå…ˆåº¦ã‚’æ˜ç¢ºã«
local rules = {
  -- 1. Explicit deny (highest priority)
  -- 2. Granular deny rules
  -- 3. Granular allow rules
  -- 4. Explicit allow (lowest priority)
}
```

### 6.3 ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

| é …ç›®                         | å®Ÿè£…çŠ¶æ³  | è©•ä¾¡            |
| ---------------------------- | --------- | --------------- |
| Input validation             | âœ“ Partial | ğŸŸ¡              |
| Output encoding              | âœ“ Yes     | âœ“               |
| Authentication               | âœ— No      | ğŸ”´ (RPC)        |
| Authorization                | âœ“ Yes     | âœ“               |
| Encryption                   | âœ— No      | ğŸŸ¡ (HTTPS only) |
| Audit logging                | âœ“ Partial | ğŸŸ¡              |
| Principle of least privilege | âœ“ Yes     | âœ“               |
| Defense in depth             | âœ“ Yes     | âœ“               |

---

## 7. ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸

### 7.1 ãƒ†ã‚¹ãƒˆç’°å¢ƒ

```
tests/
â”œâ”€â”€ minimal_init.lua              # ãƒ†ã‚¹ãƒˆç”¨æœ€å° init
â”œâ”€â”€ (è©³ç´°ãªãƒ†ã‚¹ãƒˆã‚¹ã‚¤ãƒ¼ãƒˆã¯ç¢ºèªä¸å¯)
```

**npm scripts:**

```json
"test": "node dist/bin/agent-wrapper.js --prompt 'Say hello' --cwd $(pwd)"
"test:wrapper": "node dist/bin/agent-wrapper.js --prompt 'Test wrapper functionality' --cwd ."
"test:lua": "nvim --headless -u tests/minimal_init.lua -c \"PlenaryBustedDirectory tests/ { minimal_init = 'tests/minimal_init.lua' }\""
```

### 7.2 ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸æ¨å®š

| ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«                  | ã‚«ãƒãƒ¬ãƒƒã‚¸ | å„ªå…ˆåº¦    |
| --------------------------- | ---------- | --------- |
| **infrastructure/adapter/** | ä½ã„       | ğŸ”´ High   |
| **domain/permissions/**     | ä¸­ç¨‹åº¦     | ğŸŸ¡ Medium |
| **application/chat/**       | ä¸­ç¨‹åº¦     | ğŸŸ¡ Medium |
| **presentation/chat/**      | ä½ã„       | ğŸŸ¡ Medium |
| **infrastructure/rpc/**     | ä¸æ˜       | ğŸ”´ High   |
| **bin/lib/permissions/**    | ä¸æ˜       | ğŸ”´ High   |

### 7.3 ãƒ†ã‚¹ãƒˆè¿½åŠ ã®æ¨å¥¨

#### **å„ªå…ˆåº¦: ğŸ”´ High**

1. **Agent Wrapper ãƒ†ã‚¹ãƒˆ** (`bin/agent-wrapper.ts`)

   ```typescript
   describe('agent-wrapper', () => {
     it('should validate session files', () => {
       // validateSessionFile() ã®ãƒ†ã‚¹ãƒˆ
     });
     it('should build correct prompts', () => {
       // prompt-builder ã®ãƒ†ã‚¹ãƒˆ
     });
     it('should handle permission checks', () => {
       // can-use-tool ã®ãƒ†ã‚¹ãƒˆ
     });
   });
   ```

2. **Permission Evaluator ãƒ†ã‚¹ãƒˆ**

   ```lua
   describe('Permission Evaluator', () => {
     it('should deny explicitly denied tools', () => {
       -- DENY ãŒ ALLOW ã‚’ä¸Šæ›¸ãã™ã‚‹ã“ã¨ã‚’ç¢ºèª
     });
     it('should apply granular rules correctly', () => {
       -- Path, command pattern, domain ãƒãƒƒãƒãƒ³ã‚°
     });
   });
   ```

3. **RPC ã‚µãƒ¼ãƒãƒ¼ãƒ†ã‚¹ãƒˆ**
   ```lua
   describe('RPC Server', () => {
     it('should handle buffer operations', () => {});
     it('should handle LSP operations', () => {});
     it('should route messages correctly', () => {});
   });
   ```

#### **å„ªå…ˆåº¦: ğŸŸ¡ Medium**

1. **Chat Use Case ãƒ†ã‚¹ãƒˆ**
   - Session ç®¡ç†
   - Context åé›†
   - Message é€ä¿¡ãƒ•ãƒ­ãƒ¼

2. **Stream Processing ãƒ†ã‚¹ãƒˆ**
   - JSON Line ãƒ‘ãƒ¼ã‚µãƒ¼
   - Event processor
   - Session ID ä¿å­˜

3. **Inline Action ãƒ†ã‚¹ãƒˆ**
   - Queue ç®¡ç†
   - Task å®Ÿè¡Œ
   - Cancellation

---

## 8. ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ææ¡ˆ

### 8.1 é«˜å„ªå…ˆåº¦ï¼ˆğŸ”´ Criticalï¼‰

#### **1. StreamHandler ã®è¤‡é›‘æ€§å‰Šæ¸›**

**ç¾çŠ¶:**

```lua
-- infrastructure/adapter/modules/stream_handler.lua
-- è¤‡æ•°ã®è²¬å‹™ã‚’æŒã¤
-- - Event parsing
-- - Output accumulation
-- - Error handling
-- - Session management
```

**ææ¡ˆ:**

```lua
-- åˆ†å‰²çµæœ
infrastructure/adapter/modules/
â”œâ”€â”€ stream_handler.lua (è²¬å‹™: Stream å‡ºåŠ›ã®å–å¾—)
â”œâ”€â”€ event_parser.lua (è²¬å‹™: JSON Line ã‚¤ãƒ™ãƒ³ãƒˆè§£æ)
â”œâ”€â”€ output_accumulator.lua (è²¬å‹™: ãƒ†ã‚­ã‚¹ãƒˆè“„ç©)
â””â”€â”€ error_handler.lua (è²¬å‹™: ã‚¨ãƒ©ãƒ¼å‡¦ç†)
```

**åŠ¹æœ:**

- å„ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ« <100è¡Œ
- ãƒ†ã‚¹ãƒˆå®¹æ˜“æ€§å‘ä¸Š
- å†åˆ©ç”¨æ€§å‘ä¸Š

---

#### **2. CommandBuilder ã¨ PromptBuilder ã®çµ±åˆ**

**ç¾çŠ¶:**

```
bin/lib/prompt-builder.ts  # Node.js ã§å®Ÿè£…
infrastructure/adapter/modules/command_builder.lua  # Lua ã§å®Ÿè£…
```

**å•é¡Œ:**

- ãƒ­ã‚¸ãƒƒã‚¯ãŒ2è¨€èªã«åˆ†æ•£
- åŒæœŸãŒå›°é›£
- ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ã‚³ã‚¹ãƒˆé«˜

**ææ¡ˆ:**

```
bin/lib/prompt-builder.ts (çµ±ä¸€å®Ÿè£…)
â”œâ”€ promptTemplate()
â”œâ”€ formatContext()
â””â”€ buildSession()
```

---

#### **3. Presentationå±¤ã® View çµ±åˆ**

**ç¾çŠ¶:**

```
presentation/
â”œâ”€â”€ chat/
â”‚   â”œâ”€â”€ view.lua
â”‚   â”œâ”€â”€ buffer.lua
â”‚   â””â”€â”€ modules/
â”‚       â”œâ”€â”€ window_manager.lua
â”‚       â”œâ”€â”€ file_manager.lua
â”‚       â””â”€â”€ ...5 more
â”œâ”€â”€ inline/
â”‚   â”œâ”€â”€ output_view.lua
â”‚   â””â”€â”€ progress_view.lua
â””â”€â”€ context/
    â””â”€â”€ controller.lua
```

**å•é¡Œ:**

- View å®Ÿè£…ãŒåˆ†æ•£
- è²¬å‹™ãŒä¸æ˜ç¢º
- ã‚³ãƒ¼ãƒ‰é‡è¤‡

**ææ¡ˆ:**

```
presentation/
â”œâ”€â”€ base_view.lua (BaseView: å…±é€šæ©Ÿèƒ½)
â”‚   â”œâ”€â”€ setup_buffer()
â”‚   â”œâ”€â”€ render()
â”‚   â”œâ”€â”€ update()
â”‚   â””â”€â”€ close()
â”‚
â”œâ”€â”€ chat_view.lua (ChatView extends BaseView)
â”œâ”€â”€ inline_view.lua (InlineView extends BaseView)
â””â”€â”€ context_view.lua (ContextView extends BaseView)
```

**ãƒ¡ãƒªãƒƒãƒˆ:**

- ã‚³ãƒ¼ãƒ‰å‰Šæ¸› ~200è¡Œ
- ä¸€è²«æ€§å‘ä¸Š
- æ‹¡å¼µå®¹æ˜“æ€§

---

### 8.2 ä¸­å„ªå…ˆåº¦ï¼ˆğŸŸ¡ Mediumï¼‰

#### **4. Permission Rule Evaluator ã® Refactor**

**ç¾çŠ¶:**

```lua
-- domain/permissions/evaluator.lua
-- è¤‡é›‘ãªæ¡ä»¶åˆ¤å®š
-- å„ªå…ˆåº¦ä¸æ˜ç¢º

if is_denied(tool) then
  return false
end

if is_allowed(tool) then
  return true
end

if rule_matches(tool) then
  -- ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ«ãƒ¼ãƒ«ï¼Ÿãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®šï¼Ÿæ··åœ¨
end
```

**ææ¡ˆ:**

```lua
-- Strategy ãƒ‘ã‚¿ãƒ¼ãƒ³ã®é©ç”¨
local strategies = {
  DenyListStrategy,       -- æœ€é«˜å„ªå…ˆåº¦
  GranularDenyRules,      -- æ¬¡
  GranularAllowRules,     -- æ¬¡
  AllowListStrategy,      -- æœ€ä½å„ªå…ˆåº¦
}

for _, strategy in ipairs(strategies) do
  local result = strategy:evaluate(tool, context)
  if result ~= nil then
    return result
  end
end
```

---

#### **5. Session Management ã®ä¸€å…ƒåŒ–**

**ç¾çŠ¶:**

```lua
-- è¤‡æ•°ã®å ´æ‰€ã§ session ç®¡ç†
infrastructure/adapter/modules/session_manager.lua  # Lua
bin/lib/prompt-builder.ts  # TypeScript
bin/lib/stream-processor.ts  # TypeScript
```

**ææ¡ˆ:**

```
bin/lib/session/ (ä¸€å…ƒåŒ–)
â”œâ”€â”€ manager.ts (ã‚»ãƒƒã‚·ãƒ§ãƒ³ CRUD)
â”œâ”€â”€ validator.ts (æ¤œè¨¼)
â”œâ”€â”€ repository.ts (æ°¸ç¶šåŒ–)
â””â”€â”€ serializer.ts (JSON å¤‰æ›)
```

---

#### **6. Chat Message Storage ã® Refactor**

**ç¾çŠ¶:**

```lua
-- presentation/chat/view.lua
-- Markdown ãƒ•ã‚¡ã‚¤ãƒ«ã« YAML frontmatter ã§ä¿å­˜
-- ãƒ‘ãƒ¼ã‚µãƒ¼ãŒè¤‡æ•°å­˜åœ¨

--- yaml frontmatter parsing
--- message extraction
--- session id management
--- timestamp handling
```

**ææ¡ˆ:**

```
infrastructure/storage/
â”œâ”€â”€ chat_repository.lua (interface)
â”œâ”€â”€ markdown_storage.lua (implements)
â”œâ”€â”€ chat_parser.lua
â”œâ”€â”€ frontmatter_builder.lua
â””â”€â”€ message_serializer.lua

-- åˆ©ç‚¹
-- - åˆ¥ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆå¯¾å¿œãŒå®¹æ˜“ (SQLite, JSON)
-- - ãƒ†ã‚¹ãƒˆå®¹æ˜“æ€§å‘ä¸Š
-- - è¤‡é›‘æ€§å‰Šæ¸›
```

---

### 8.3 ä½å„ªå…ˆåº¦ï¼ˆğŸŸ¢ Lowï¼‰

#### **7. UI ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãƒ©ã‚¤ãƒ–ãƒ©ãƒªåŒ–**

```lua
-- ui/components/
â”œâ”€â”€ button.lua
â”œâ”€â”€ selector.lua
â”œâ”€â”€ text_input.lua
â”œâ”€â”€ notification.lua
â””â”€â”€ layout.lua

-- åˆ©ç‚¹: å†åˆ©ç”¨æ€§ã€ä¸€è²«æ€§
```

---

#### **8. Error Handling ã®çµ±ä¸€**

```lua
-- domain/errors/
â”œâ”€â”€ base_error.lua
â”œâ”€â”€ permission_error.lua
â”œâ”€â”€ validation_error.lua
â”œâ”€â”€ session_error.lua
â””â”€â”€ handler.lua

-- Try-Catch ãƒ©ãƒƒãƒ‘ãƒ¼
local ok, result = pcall(function()
  -- ...
end)

if not ok then
  local err = domain.errors.handler(result)
  notify.error(err:formatted_message())
end
```

---

### 8.4 ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°å®Ÿè£…è¨ˆç”»

| ææ¡ˆ                   | æ¨å®šå·¥æ•° | åŠ¹æœ | ãƒªã‚¹ã‚¯ |
| ---------------------- | -------- | ---- | ------ |
| 1. StreamHandler åˆ†å‰²  | 8h       | é«˜   | ä½     |
| 2. CommandBuilder çµ±åˆ | 12h      | é«˜   | ä¸­     |
| 3. View çµ±åˆ           | 16h      | ä¸­   | ä¸­     |
| 4. Permission Strategy | 6h       | ä¸­   | ä½     |
| 5. Session çµ±ä¸€        | 10h      | ä¸­   | ä¸­     |
| 6. Storage Repository  | 14h      | é«˜   | ä¸­     |
| 7. UI Components       | 8h       | ä½   | ä½     |
| 8. Error Handling      | 6h       | ä¸­   | ä½     |
| **åˆè¨ˆ**               | **80h**  | -    | -      |

---

## ã¾ã¨ã‚

### å¼·ã¿ âœ“

- **å®Œå…¨ãª Clean Architecture** - DDD åŸå‰‡ã«å¾“ã£ãŸå±¤åˆ¥è¨­è¨ˆ
- **æŸ”è»Ÿãªæ¨©é™åˆ¶å¾¡** - Granular rules + è¤‡æ•°ãƒ¢ãƒ¼ãƒ‰
- **ãƒãƒ«ãƒã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå¯¾å¿œ** - Squad æ©Ÿèƒ½ã§è¤‡æ•° Claude ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ç®¡ç†
- **åŒ…æ‹¬çš„ãª MCP çµ±åˆ** - RPC ã‚µãƒ¼ãƒãƒ¼ã§ Neovim æ‹¡å¼µ
- **å„ªã‚ŒãŸ ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°** - Path sanitization, validation

### æ”¹å–„é ˜åŸŸ âš ï¸

- **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹** - Streaming ã®æœ€é©åŒ–ã€ãƒãƒƒãƒå‡¦ç†
- **ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸** - Agent Wrapper, Permission evaluator
- **ã‚³ãƒ¼ãƒ‰é‡è¤‡** - è¤‡æ•°ã® View å®Ÿè£…ã€Session ç®¡ç†åˆ†æ•£
- **è¤‡é›‘æ€§** - StreamHandler, PermissionEvaluator ã®è²¬å‹™éå¤š
- **ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ** - ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä¸è¶³

### æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

1. **çŸ­æœŸ**: ãƒ†ã‚¹ãƒˆã‚¹ã‚¤ãƒ¼ãƒˆæ‹¡å……ï¼ˆPriority: Highï¼‰
2. **ä¸­æœŸ**: StreamHandler ã¨ Permission Strategy ã® Refactor
3. **é•·æœŸ**: Storage Repository ãƒ‘ã‚¿ãƒ¼ãƒ³å°å…¥ã€UI ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆåŒ–
